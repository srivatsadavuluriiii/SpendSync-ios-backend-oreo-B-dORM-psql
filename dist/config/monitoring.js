"use strict"; /**
 * Monitoring Configuration
 * 
 * This file sets up Prometheus monitoring for the service
 */

const promClient = require('prom-client');
const promMiddleware = require('express-prometheus-middleware');

// Create a Registry to register metrics
const register = new promClient.Registry();

// Add a default label to all metrics
promClient.collectDefaultMetrics({
  register,
  prefix: 'spendsync_settlement_',
  labels: { service: 'settlement-service' }
});

// Custom metrics
const settlementCreatedCounter = new promClient.Counter({
  name: 'spendsync_settlement_created_total',
  help: 'Total number of settlements created',
  labelNames: ['status', 'currency']
});

const settlementStatusChangedCounter = new promClient.Counter({
  name: 'spendsync_settlement_status_changed_total',
  help: 'Total number of settlement status changes',
  labelNames: ['from', 'to']
});

const algorithmExecutionHistogram = new promClient.Histogram({
  name: 'spendsync_settlement_algorithm_execution_seconds',
  help: 'Settlement algorithm execution time in seconds',
  labelNames: ['algorithm'],
  buckets: [0.01, 0.05, 0.1, 0.5, 1, 2, 5, 10]
});

const dbOperationHistogram = new promClient.Histogram({
  name: 'spendsync_settlement_db_operation_seconds',
  help: 'Database operation execution time in seconds',
  labelNames: ['operation', 'collection'],
  buckets: [0.01, 0.05, 0.1, 0.5, 1, 2, 5]
});

// Register custom metrics
register.registerMetric(settlementCreatedCounter);
register.registerMetric(settlementStatusChangedCounter);
register.registerMetric(algorithmExecutionHistogram);
register.registerMetric(dbOperationHistogram);

// Prometheus middleware configuration
const prometheusMiddleware = promMiddleware({
  metricsPath: '/metrics',
  collectDefaultMetrics: false, // We're collecting them separately with our own configuration
  requestDurationBuckets: [0.1, 0.5, 1, 1.5, 2, 5, 10],
  requestLengthBuckets: [512, 1024, 5120, 10240, 51200, 102400],
  responseLengthBuckets: [512, 1024, 5120, 10240, 51200, 102400],
  metricsPrefix: 'spendsync_http_',
  authenticate: process.env.NODE_ENV === 'production' ? true : false, // Optional HTTP basic auth
  credentialsProvider: () => ({ user: process.env.METRICS_USER, password: process.env.METRICS_PASSWORD })
});

// Database operation timer
const createDbTimer = (operation, collection) => {
  return dbOperationHistogram.startTimer({ operation, collection });
};

// Algorithm execution timer
const createAlgorithmTimer = (algorithm) => {
  return algorithmExecutionHistogram.startTimer({ algorithm });
};

module.exports = {
  register,
  prometheusMiddleware,
  metrics: {
    settlementCreatedCounter,
    settlementStatusChangedCounter,
    algorithmExecutionHistogram,
    dbOperationHistogram
  },
  timers: {
    createDbTimer,
    createAlgorithmTimer
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJwcm9tQ2xpZW50IiwicmVxdWlyZSIsInByb21NaWRkbGV3YXJlIiwicmVnaXN0ZXIiLCJSZWdpc3RyeSIsImNvbGxlY3REZWZhdWx0TWV0cmljcyIsInByZWZpeCIsImxhYmVscyIsInNlcnZpY2UiLCJzZXR0bGVtZW50Q3JlYXRlZENvdW50ZXIiLCJDb3VudGVyIiwibmFtZSIsImhlbHAiLCJsYWJlbE5hbWVzIiwic2V0dGxlbWVudFN0YXR1c0NoYW5nZWRDb3VudGVyIiwiYWxnb3JpdGhtRXhlY3V0aW9uSGlzdG9ncmFtIiwiSGlzdG9ncmFtIiwiYnVja2V0cyIsImRiT3BlcmF0aW9uSGlzdG9ncmFtIiwicmVnaXN0ZXJNZXRyaWMiLCJwcm9tZXRoZXVzTWlkZGxld2FyZSIsIm1ldHJpY3NQYXRoIiwicmVxdWVzdER1cmF0aW9uQnVja2V0cyIsInJlcXVlc3RMZW5ndGhCdWNrZXRzIiwicmVzcG9uc2VMZW5ndGhCdWNrZXRzIiwibWV0cmljc1ByZWZpeCIsImF1dGhlbnRpY2F0ZSIsInByb2Nlc3MiLCJlbnYiLCJOT0RFX0VOViIsImNyZWRlbnRpYWxzUHJvdmlkZXIiLCJ1c2VyIiwiTUVUUklDU19VU0VSIiwicGFzc3dvcmQiLCJNRVRSSUNTX1BBU1NXT1JEIiwiY3JlYXRlRGJUaW1lciIsIm9wZXJhdGlvbiIsImNvbGxlY3Rpb24iLCJzdGFydFRpbWVyIiwiY3JlYXRlQWxnb3JpdGhtVGltZXIiLCJhbGdvcml0aG0iLCJtb2R1bGUiLCJleHBvcnRzIiwibWV0cmljcyIsInRpbWVycyJdLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb25maWcvbW9uaXRvcmluZy5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIE1vbml0b3JpbmcgQ29uZmlndXJhdGlvblxuICogXG4gKiBUaGlzIGZpbGUgc2V0cyB1cCBQcm9tZXRoZXVzIG1vbml0b3JpbmcgZm9yIHRoZSBzZXJ2aWNlXG4gKi9cblxuY29uc3QgcHJvbUNsaWVudCA9IHJlcXVpcmUoJ3Byb20tY2xpZW50Jyk7XG5jb25zdCBwcm9tTWlkZGxld2FyZSA9IHJlcXVpcmUoJ2V4cHJlc3MtcHJvbWV0aGV1cy1taWRkbGV3YXJlJyk7XG5cbi8vIENyZWF0ZSBhIFJlZ2lzdHJ5IHRvIHJlZ2lzdGVyIG1ldHJpY3NcbmNvbnN0IHJlZ2lzdGVyID0gbmV3IHByb21DbGllbnQuUmVnaXN0cnkoKTtcblxuLy8gQWRkIGEgZGVmYXVsdCBsYWJlbCB0byBhbGwgbWV0cmljc1xucHJvbUNsaWVudC5jb2xsZWN0RGVmYXVsdE1ldHJpY3Moe1xuICByZWdpc3RlcixcbiAgcHJlZml4OiAnc3BlbmRzeW5jX3NldHRsZW1lbnRfJyxcbiAgbGFiZWxzOiB7IHNlcnZpY2U6ICdzZXR0bGVtZW50LXNlcnZpY2UnIH1cbn0pO1xuXG4vLyBDdXN0b20gbWV0cmljc1xuY29uc3Qgc2V0dGxlbWVudENyZWF0ZWRDb3VudGVyID0gbmV3IHByb21DbGllbnQuQ291bnRlcih7XG4gIG5hbWU6ICdzcGVuZHN5bmNfc2V0dGxlbWVudF9jcmVhdGVkX3RvdGFsJyxcbiAgaGVscDogJ1RvdGFsIG51bWJlciBvZiBzZXR0bGVtZW50cyBjcmVhdGVkJyxcbiAgbGFiZWxOYW1lczogWydzdGF0dXMnLCAnY3VycmVuY3knXVxufSk7XG5cbmNvbnN0IHNldHRsZW1lbnRTdGF0dXNDaGFuZ2VkQ291bnRlciA9IG5ldyBwcm9tQ2xpZW50LkNvdW50ZXIoe1xuICBuYW1lOiAnc3BlbmRzeW5jX3NldHRsZW1lbnRfc3RhdHVzX2NoYW5nZWRfdG90YWwnLFxuICBoZWxwOiAnVG90YWwgbnVtYmVyIG9mIHNldHRsZW1lbnQgc3RhdHVzIGNoYW5nZXMnLFxuICBsYWJlbE5hbWVzOiBbJ2Zyb20nLCAndG8nXVxufSk7XG5cbmNvbnN0IGFsZ29yaXRobUV4ZWN1dGlvbkhpc3RvZ3JhbSA9IG5ldyBwcm9tQ2xpZW50Lkhpc3RvZ3JhbSh7XG4gIG5hbWU6ICdzcGVuZHN5bmNfc2V0dGxlbWVudF9hbGdvcml0aG1fZXhlY3V0aW9uX3NlY29uZHMnLFxuICBoZWxwOiAnU2V0dGxlbWVudCBhbGdvcml0aG0gZXhlY3V0aW9uIHRpbWUgaW4gc2Vjb25kcycsXG4gIGxhYmVsTmFtZXM6IFsnYWxnb3JpdGhtJ10sXG4gIGJ1Y2tldHM6IFswLjAxLCAwLjA1LCAwLjEsIDAuNSwgMSwgMiwgNSwgMTBdXG59KTtcblxuY29uc3QgZGJPcGVyYXRpb25IaXN0b2dyYW0gPSBuZXcgcHJvbUNsaWVudC5IaXN0b2dyYW0oe1xuICBuYW1lOiAnc3BlbmRzeW5jX3NldHRsZW1lbnRfZGJfb3BlcmF0aW9uX3NlY29uZHMnLFxuICBoZWxwOiAnRGF0YWJhc2Ugb3BlcmF0aW9uIGV4ZWN1dGlvbiB0aW1lIGluIHNlY29uZHMnLFxuICBsYWJlbE5hbWVzOiBbJ29wZXJhdGlvbicsICdjb2xsZWN0aW9uJ10sXG4gIGJ1Y2tldHM6IFswLjAxLCAwLjA1LCAwLjEsIDAuNSwgMSwgMiwgNV1cbn0pO1xuXG4vLyBSZWdpc3RlciBjdXN0b20gbWV0cmljc1xucmVnaXN0ZXIucmVnaXN0ZXJNZXRyaWMoc2V0dGxlbWVudENyZWF0ZWRDb3VudGVyKTtcbnJlZ2lzdGVyLnJlZ2lzdGVyTWV0cmljKHNldHRsZW1lbnRTdGF0dXNDaGFuZ2VkQ291bnRlcik7XG5yZWdpc3Rlci5yZWdpc3Rlck1ldHJpYyhhbGdvcml0aG1FeGVjdXRpb25IaXN0b2dyYW0pO1xucmVnaXN0ZXIucmVnaXN0ZXJNZXRyaWMoZGJPcGVyYXRpb25IaXN0b2dyYW0pO1xuXG4vLyBQcm9tZXRoZXVzIG1pZGRsZXdhcmUgY29uZmlndXJhdGlvblxuY29uc3QgcHJvbWV0aGV1c01pZGRsZXdhcmUgPSBwcm9tTWlkZGxld2FyZSh7XG4gIG1ldHJpY3NQYXRoOiAnL21ldHJpY3MnLFxuICBjb2xsZWN0RGVmYXVsdE1ldHJpY3M6IGZhbHNlLCAvLyBXZSdyZSBjb2xsZWN0aW5nIHRoZW0gc2VwYXJhdGVseSB3aXRoIG91ciBvd24gY29uZmlndXJhdGlvblxuICByZXF1ZXN0RHVyYXRpb25CdWNrZXRzOiBbMC4xLCAwLjUsIDEsIDEuNSwgMiwgNSwgMTBdLFxuICByZXF1ZXN0TGVuZ3RoQnVja2V0czogWzUxMiwgMTAyNCwgNTEyMCwgMTAyNDAsIDUxMjAwLCAxMDI0MDBdLFxuICByZXNwb25zZUxlbmd0aEJ1Y2tldHM6IFs1MTIsIDEwMjQsIDUxMjAsIDEwMjQwLCA1MTIwMCwgMTAyNDAwXSxcbiAgbWV0cmljc1ByZWZpeDogJ3NwZW5kc3luY19odHRwXycsXG4gIGF1dGhlbnRpY2F0ZTogcHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09ICdwcm9kdWN0aW9uJyA/IHRydWUgOiBmYWxzZSwgLy8gT3B0aW9uYWwgSFRUUCBiYXNpYyBhdXRoXG4gIGNyZWRlbnRpYWxzUHJvdmlkZXI6ICgpID0+ICh7IHVzZXI6IHByb2Nlc3MuZW52Lk1FVFJJQ1NfVVNFUiwgcGFzc3dvcmQ6IHByb2Nlc3MuZW52Lk1FVFJJQ1NfUEFTU1dPUkQgfSksXG59KTtcblxuLy8gRGF0YWJhc2Ugb3BlcmF0aW9uIHRpbWVyXG5jb25zdCBjcmVhdGVEYlRpbWVyID0gKG9wZXJhdGlvbiwgY29sbGVjdGlvbikgPT4ge1xuICByZXR1cm4gZGJPcGVyYXRpb25IaXN0b2dyYW0uc3RhcnRUaW1lcih7IG9wZXJhdGlvbiwgY29sbGVjdGlvbiB9KTtcbn07XG5cbi8vIEFsZ29yaXRobSBleGVjdXRpb24gdGltZXJcbmNvbnN0IGNyZWF0ZUFsZ29yaXRobVRpbWVyID0gKGFsZ29yaXRobSkgPT4ge1xuICByZXR1cm4gYWxnb3JpdGhtRXhlY3V0aW9uSGlzdG9ncmFtLnN0YXJ0VGltZXIoeyBhbGdvcml0aG0gfSk7XG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IHtcbiAgcmVnaXN0ZXIsXG4gIHByb21ldGhldXNNaWRkbGV3YXJlLFxuICBtZXRyaWNzOiB7XG4gICAgc2V0dGxlbWVudENyZWF0ZWRDb3VudGVyLFxuICAgIHNldHRsZW1lbnRTdGF0dXNDaGFuZ2VkQ291bnRlcixcbiAgICBhbGdvcml0aG1FeGVjdXRpb25IaXN0b2dyYW0sXG4gICAgZGJPcGVyYXRpb25IaXN0b2dyYW1cbiAgfSxcbiAgdGltZXJzOiB7XG4gICAgY3JlYXRlRGJUaW1lcixcbiAgICBjcmVhdGVBbGdvcml0aG1UaW1lclxuICB9XG59OyAiXSwibWFwcGluZ3MiOiJjQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsTUFBTUEsVUFBVSxHQUFHQyxPQUFPLENBQUMsYUFBYSxDQUFDO0FBQ3pDLE1BQU1DLGNBQWMsR0FBR0QsT0FBTyxDQUFDLCtCQUErQixDQUFDOztBQUUvRDtBQUNBLE1BQU1FLFFBQVEsR0FBRyxJQUFJSCxVQUFVLENBQUNJLFFBQVEsQ0FBQyxDQUFDOztBQUUxQztBQUNBSixVQUFVLENBQUNLLHFCQUFxQixDQUFDO0VBQy9CRixRQUFRO0VBQ1JHLE1BQU0sRUFBRSx1QkFBdUI7RUFDL0JDLE1BQU0sRUFBRSxFQUFFQyxPQUFPLEVBQUUsb0JBQW9CLENBQUM7QUFDMUMsQ0FBQyxDQUFDOztBQUVGO0FBQ0EsTUFBTUMsd0JBQXdCLEdBQUcsSUFBSVQsVUFBVSxDQUFDVSxPQUFPLENBQUM7RUFDdERDLElBQUksRUFBRSxvQ0FBb0M7RUFDMUNDLElBQUksRUFBRSxxQ0FBcUM7RUFDM0NDLFVBQVUsRUFBRSxDQUFDLFFBQVEsRUFBRSxVQUFVO0FBQ25DLENBQUMsQ0FBQzs7QUFFRixNQUFNQyw4QkFBOEIsR0FBRyxJQUFJZCxVQUFVLENBQUNVLE9BQU8sQ0FBQztFQUM1REMsSUFBSSxFQUFFLDJDQUEyQztFQUNqREMsSUFBSSxFQUFFLDJDQUEyQztFQUNqREMsVUFBVSxFQUFFLENBQUMsTUFBTSxFQUFFLElBQUk7QUFDM0IsQ0FBQyxDQUFDOztBQUVGLE1BQU1FLDJCQUEyQixHQUFHLElBQUlmLFVBQVUsQ0FBQ2dCLFNBQVMsQ0FBQztFQUMzREwsSUFBSSxFQUFFLGtEQUFrRDtFQUN4REMsSUFBSSxFQUFFLGdEQUFnRDtFQUN0REMsVUFBVSxFQUFFLENBQUMsV0FBVyxDQUFDO0VBQ3pCSSxPQUFPLEVBQUUsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsQ0FB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