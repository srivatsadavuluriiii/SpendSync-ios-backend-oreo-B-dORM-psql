"use strict";var _interopRequireDefault = require("@babel/runtime-corejs3/helpers/interopRequireDefault");var _find = _interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/find"));var _forEach = _interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/for-each"));var _reduce = _interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/reduce"));var _mongoose = _interopRequireDefault(require("mongoose"));
var _setup = require("../setup.js");
var _AnalyticsEvent = _interopRequireDefault(require("../../src/models/AnalyticsEvent.js"));
var _SpendingReport = _interopRequireDefault(require("../../src/models/SpendingReport.js"));

describe('Data Processing Pipeline Integration Tests', () => {
  beforeAll(async () => {
    await (0, _setup.setupTestDB)();
  });

  afterAll(async () => {
    await (0, _setup.teardownTestDB)();
  });

  beforeEach(async () => {
    await _AnalyticsEvent.default.deleteMany({});
    await _SpendingReport.default.deleteMany({});
  });

  describe('Data Ingestion Pipeline', () => {
    test('should successfully ingest and process batch expense data', async () => {
      const testExpenses = (0, _setup.generateTestExpenses)(100);

      // Batch insert expenses
      await _AnalyticsEvent.default.insertMany(testExpenses);

      // Verify data was properly stored
      const storedExpenses = await (0, _find.default)(_AnalyticsEvent.default).call(_AnalyticsEvent.default, {});
      expect(storedExpenses).toHaveLength(100);

      // Verify data integrity
      const randomExpense = testExpenses[0];
      const storedExpense = await _AnalyticsEvent.default.findOne({
        userId: randomExpense.userId,
        timestamp: randomExpense.timestamp
      });

      expect(storedExpense).toBeDefined();
      expect(storedExpense.amount).toBe(randomExpense.amount);
      expect(storedExpense.category).toBe(randomExpense.category);
    });

    test('should handle duplicate expense entries correctly', async () => {
      const testExpense = (0, _setup.generateTestExpenses)(1)[0];

      // Try to insert the same expense twice
      await _AnalyticsEvent.default.create(testExpense);
      await expect(_AnalyticsEvent.default.create(testExpense)).rejects.toThrow();

      // Verify only one record exists
      const count = await _AnalyticsEvent.default.countDocuments({
        userId: testExpense.userId,
        timestamp: testExpense.timestamp
      });
      expect(count).toBe(1);
    });
  });

  describe('Data Aggregation Pipeline', () => {
    test('should generate accurate daily spending reports', async () => {
      const testExpenses = (0, _setup.generateTestExpenses)(50);
      await _AnalyticsEvent.default.insertMany(testExpenses);

      // Group expenses by date
      const pipeline = [
      {
        $group: {
          _id: {
            date: { $dateToString: { format: '%Y-%m-%d', date: '$timestamp' } },
            category: '$category'
          },
          totalAmount: { $sum: '$amount' },
          count: { $sum: 1 }
        }
      }];


      const dailyReport = await _AnalyticsEvent.default.aggregate(pipeline);
      expect(dailyReport.length).toBeGreaterThan(0);

      // Verify report structure
      const sampleReport = dailyReport[0];
      expect(sampleReport._id).toHaveProperty('date');
      expect(sampleReport._id).toHaveProperty('category');
      expect(sampleReport).toHaveProperty('totalAmount');
      expect(sampleReport).toHaveProperty('count');
    });

    test('should calculate correct monthly category totals', async () => {
      const testExpenses = (0, _setup.generateTestExpenses)(100);
      await _AnalyticsEvent.default.insertMany(testExpenses);

      const pipeline = [
      {
        $group: {
          _id: {
            month: { $month: '$timestamp' },
            category: '$category'
          },
          totalAmount: { $sum: '$amount' }
        }
      }];


      const monthlyTotals = await _AnalyticsEvent.default.aggregate(pipeline);

      // Verify totals
      (0, _forEach.default)(monthlyTotals).call(monthlyTotals, (total) => {
        expect(total.totalAmount).toBeGreaterThan(0);
        expect(total._id.month).toBeLessThanOrEqual(12);
        expect(total._id.month).toBeGreaterThanOrEqual(1);
      });
    });
  });

  describe('Report Generation Pipeline', () => {
    test('should generate and store spending reports', async () => {
      const testExpenses = (0, _setup.generateTestExpenses)(100);
      await _AnalyticsEvent.default.insertMany(testExpenses);

      // Generate report
      const reportData = {
        userId: testExpenses[0].userId,
        period: 'monthly',
        startDate: new Date('2024-01-01'),
        endDate: new Date('2024-01-31'),
        totalSpending: (0, _reduce.default)(testExpenses).call(testExpenses, (sum, exp) => sum + exp.amount, 0),
        categoryBreakdown: {},
        timestamp: new Date()
      };

      const report = await _SpendingReport.default.create(reportData);

      // Verify report was stored
      expect(report._id).toBeDefined();
      expect(report.userId).toBe(reportData.userId);
      expect(report.totalSpending).toBe(reportData.totalSpending);
    });

    test('should update existing reports with new data', async () => {
      const testExpenses = (0, _setup.generateTestExpenses)(50);
      await _AnalyticsEvent.default.insertMany(testExpenses);

      // Create initial report
      const initialReport = await _SpendingReport.default.create({
        userId: testExpenses[0].userId,
        period: 'monthly',
        startDate: new Date('2024-01-01'),
        endDate: new Date('2024-01-31'),
        totalSpending: 1000,
        categoryBreakdown: {},
        timestamp: new Date()
      });

      // Update report
      const updatedTotal = 1500;
      await _SpendingReport.default.findByIdAndUpdate(
        initialReport._id,
        { totalSpending: updatedTotal },
        { new: true }
      );

      // Verify update
      const report = await _SpendingReport.default.findById(initialReport._id);
      expect(report.totalSpending).toBe(updatedTotal);
    });
  });

  describe('Error Handling', () => {
    test('should handle invalid data gracefully', async () => {
      const invalidExpense = {
        userId: 'test-user',
        amount: 'invalid-amount', // Should be a number
        timestamp: new Date(),
        category: 'food'
      };

      await expect(_AnalyticsEvent.default.create(invalidExpense)).rejects.toThrow();
    });

    test('should handle missing required fields', async () => {
      const incompleteExpense = {
        userId: 'test-user',
        // Missing amount and category
        timestamp: new Date()
      };

      await expect(_AnalyticsEvent.default.create(incompleteExpense)).rejects.toThrow();
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfbW9uZ29vc2UiLCJfaW50ZXJvcFJlcXVpcmVEZWZhdWx0IiwicmVxdWlyZSIsIl9zZXR1cCIsIl9BbmFseXRpY3NFdmVudCIsIl9TcGVuZGluZ1JlcG9ydCIsImRlc2NyaWJlIiwiYmVmb3JlQWxsIiwic2V0dXBUZXN0REIiLCJhZnRlckFsbCIsInRlYXJkb3duVGVzdERCIiwiYmVmb3JlRWFjaCIsIkFuYWx5dGljc0V2ZW50IiwiZGVsZXRlTWFueSIsIlNwZW5kaW5nUmVwb3J0IiwidGVzdCIsInRlc3RFeHBlbnNlcyIsImdlbmVyYXRlVGVzdEV4cGVuc2VzIiwiaW5zZXJ0TWFueSIsInN0b3JlZEV4cGVuc2VzIiwiX2ZpbmQiLCJkZWZhdWx0IiwiY2FsbCIsImV4cGVjdCIsInRvSGF2ZUxlbmd0aCIsInJhbmRvbUV4cGVuc2UiLCJzdG9yZWRFeHBlbnNlIiwiZmluZE9uZSIsInVzZXJJZCIsInRpbWVzdGFtcCIsInRvQmVEZWZpbmVkIiwiYW1vdW50IiwidG9CZSIsImNhdGVnb3J5IiwidGVzdEV4cGVuc2UiLCJjcmVhdGUiLCJyZWplY3RzIiwidG9UaHJvdyIsImNvdW50IiwiY291bnREb2N1bWVudHMiLCJwaXBlbGluZSIsIiRncm91cCIsIl9pZCIsImRhdGUiLCIkZGF0ZVRvU3RyaW5nIiwiZm9ybWF0IiwidG90YWxBbW91bnQiLCIkc3VtIiwiZGFpbHlSZXBvcnQiLCJhZ2dyZWdhdGUiLCJsZW5ndGgiLCJ0b0JlR3JlYXRlclRoYW4iLCJzYW1wbGVSZXBvcnQiLCJ0b0hhdmVQcm9wZXJ0eSIsIm1vbnRoIiwiJG1vbnRoIiwibW9udGhseVRvdGFscyIsIl9mb3JFYWNoIiwidG90YWwiLCJ0b0JlTGVzc1RoYW5PckVxdWFsIiwidG9CZUdyZWF0ZXJUaGFuT3JFcXVhbCIsInJlcG9ydERhdGEiLCJwZXJpb2QiLCJzdGFydERhdGUiLCJEYXRlIiwiZW5kRGF0ZSIsInRvdGFsU3BlbmRpbmciLCJfcmVkdWNlIiwic3VtIiwiZXhwIiwiY2F0ZWdvcnlCcmVha2Rvd24iLCJyZXBvcnQiLCJpbml0aWFsUmVwb3J0IiwidXBkYXRlZFRvdGFsIiwiZmluZEJ5SWRBbmRVcGRhdGUiLCJuZXciLCJmaW5kQnlJZCIsImludmFsaWRFeHBlbnNlIiwiaW5jb21wbGV0ZUV4cGVuc2UiXSwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvc2VydmljZXMvYW5hbHl0aWNzLXNlcnZpY2UvX190ZXN0c19fL2ludGVncmF0aW9uL2RhdGEtcGlwZWxpbmUudGVzdC5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbW9uZ29vc2UgZnJvbSAnbW9uZ29vc2UnO1xuaW1wb3J0IHsgc2V0dXBUZXN0REIsIHRlYXJkb3duVGVzdERCLCBnZW5lcmF0ZVRlc3RFeHBlbnNlcyB9IGZyb20gJy4uL3NldHVwLmpzJztcbmltcG9ydCBBbmFseXRpY3NFdmVudCBmcm9tICcuLi8uLi9zcmMvbW9kZWxzL0FuYWx5dGljc0V2ZW50LmpzJztcbmltcG9ydCBTcGVuZGluZ1JlcG9ydCBmcm9tICcuLi8uLi9zcmMvbW9kZWxzL1NwZW5kaW5nUmVwb3J0LmpzJztcblxuZGVzY3JpYmUoJ0RhdGEgUHJvY2Vzc2luZyBQaXBlbGluZSBJbnRlZ3JhdGlvbiBUZXN0cycsICgpID0+IHtcbiAgYmVmb3JlQWxsKGFzeW5jICgpID0+IHtcbiAgICBhd2FpdCBzZXR1cFRlc3REQigpO1xuICB9KTtcblxuICBhZnRlckFsbChhc3luYyAoKSA9PiB7XG4gICAgYXdhaXQgdGVhcmRvd25UZXN0REIoKTtcbiAgfSk7XG5cbiAgYmVmb3JlRWFjaChhc3luYyAoKSA9PiB7XG4gICAgYXdhaXQgQW5hbHl0aWNzRXZlbnQuZGVsZXRlTWFueSh7fSk7XG4gICAgYXdhaXQgU3BlbmRpbmdSZXBvcnQuZGVsZXRlTWFueSh7fSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdEYXRhIEluZ2VzdGlvbiBQaXBlbGluZScsICgpID0+IHtcbiAgICB0ZXN0KCdzaG91bGQgc3VjY2Vzc2Z1bGx5IGluZ2VzdCBhbmQgcHJvY2VzcyBiYXRjaCBleHBlbnNlIGRhdGEnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCB0ZXN0RXhwZW5zZXMgPSBnZW5lcmF0ZVRlc3RFeHBlbnNlcygxMDApO1xuICAgICAgXG4gICAgICAvLyBCYXRjaCBpbnNlcnQgZXhwZW5zZXNcbiAgICAgIGF3YWl0IEFuYWx5dGljc0V2ZW50Lmluc2VydE1hbnkodGVzdEV4cGVuc2VzKTtcbiAgICAgIFxuICAgICAgLy8gVmVyaWZ5IGRhdGEgd2FzIHByb3Blcmx5IHN0b3JlZFxuICAgICAgY29uc3Qgc3RvcmVkRXhwZW5zZXMgPSBhd2FpdCBBbmFseXRpY3NFdmVudC5maW5kKHt9KTtcbiAgICAgIGV4cGVjdChzdG9yZWRFeHBlbnNlcykudG9IYXZlTGVuZ3RoKDEwMCk7XG4gICAgICBcbiAgICAgIC8vIFZlcmlmeSBkYXRhIGludGVncml0eVxuICAgICAgY29uc3QgcmFuZG9tRXhwZW5zZSA9IHRlc3RFeHBlbnNlc1swXTtcbiAgICAgIGNvbnN0IHN0b3JlZEV4cGVuc2UgPSBhd2FpdCBBbmFseXRpY3NFdmVudC5maW5kT25lKHtcbiAgICAgICAgdXNlcklkOiByYW5kb21FeHBlbnNlLnVzZXJJZCxcbiAgICAgICAgdGltZXN0YW1wOiByYW5kb21FeHBlbnNlLnRpbWVzdGFtcFxuICAgICAgfSk7XG4gICAgICBcbiAgICAgIGV4cGVjdChzdG9yZWRFeHBlbnNlKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KHN0b3JlZEV4cGVuc2UuYW1vdW50KS50b0JlKHJhbmRvbUV4cGVuc2UuYW1vdW50KTtcbiAgICAgIGV4cGVjdChzdG9yZWRFeHBlbnNlLmNhdGVnb3J5KS50b0JlKHJhbmRvbUV4cGVuc2UuY2F0ZWdvcnkpO1xuICAgIH0pO1xuXG4gICAgdGVzdCgnc2hvdWxkIGhhbmRsZSBkdXBsaWNhdGUgZXhwZW5zZSBlbnRyaWVzIGNvcnJlY3RseScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHRlc3RFeHBlbnNlID0gZ2VuZXJhdGVUZXN0RXhwZW5zZXMoMSlbMF07XG4gICAgICBcbiAgICAgIC8vIFRyeSB0byBpbnNlcnQgdGhlIHNhbWUgZXhwZW5zZSB0d2ljZVxuICAgICAgYXdhaXQgQW5hbHl0aWNzRXZlbnQuY3JlYXRlKHRlc3RFeHBlbnNlKTtcbiAgICAgIGF3YWl0IGV4cGVjdChBbmFseXRpY3NFdmVudC5jcmVhdGUodGVzdEV4cGVuc2UpKS5yZWplY3RzLnRvVGhyb3coKTtcbiAgICAgIFxuICAgICAgLy8gVmVyaWZ5IG9ubHkgb25lIHJlY29yZCBleGlzdHNcbiAgICAgIGNvbnN0IGNvdW50ID0gYXdhaXQgQW5hbHl0aWNzRXZlbnQuY291bnREb2N1bWVudHMoe1xuICAgICAgICB1c2VySWQ6IHRlc3RFeHBlbnNlLnVzZXJJZCxcbiAgICAgICAgdGltZXN0YW1wOiB0ZXN0RXhwZW5zZS50aW1lc3RhbXBcbiAgICAgIH0pO1xuICAgICAgZXhwZWN0KGNvdW50KS50b0JlKDEpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnRGF0YSBBZ2dyZWdhdGlvbiBQaXBlbGluZScsICgpID0+IHtcbiAgICB0ZXN0KCdzaG91bGQgZ2VuZXJhdGUgYWNjdXJhdGUgZGFpbHkgc3BlbmRpbmcgcmVwb3J0cycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHRlc3RFeHBlbnNlcyA9IGdlbmVyYXRlVGVzdEV4cGVuc2VzKDUwKTtcbiAgICAgIGF3YWl0IEFuYWx5dGljc0V2ZW50Lmluc2VydE1hbnkodGVzdEV4cGVuc2VzKTtcblxuICAgICAgLy8gR3JvdXAgZXhwZW5zZXMgYnkgZGF0ZVxuICAgICAgY29uc3QgcGlwZWxpbmUgPSBbXG4gICAgICAgIHtcbiAgICAgICAgICAkZ3JvdXA6IHtcbiAgICAgICAgICAgIF9pZDoge1xuICAgICAgICAgICAgICBkYXRlOiB7ICRkYXRlVG9TdHJpbmc6IHsgZm9ybWF0OiAnJVktJW0tJWQnLCBkYXRlOiAnJHRpbWVzdGFtcCcgfSB9LFxuICAgICAgICAgICAgICBjYXRlZ29yeTogJyRjYXRlZ29yeSdcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB0b3RhbEFtb3VudDogeyAkc3VtOiAnJGFtb3VudCcgfSxcbiAgICAgICAgICAgIGNvdW50OiB7ICRzdW06IDEgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgXTtcblxuICAgICAgY29uc3QgZGFpbHlSZXBvcnQgPSBhd2FpdCBBbmFseXRpY3NFdmVudC5hZ2dyZWdhdGUocGlwZWxpbmUpO1xuICAgICAgZXhwZWN0KGRhaWx5UmVwb3J0Lmxlbmd0aCkudG9CZUdyZWF0ZXJUaGFuKDApO1xuICAgICAgXG4gICAgICAvLyBWZXJpZnkgcmVwb3J0IHN0cnVjdHVyZVxuICAgICAgY29uc3Qgc2FtcGxlUmVwb3J0ID0gZGFpbHlSZXBvcnRbMF07XG4gICAgICBleHBlY3Qoc2FtcGxlUmVwb3J0Ll9pZCkudG9IYXZlUHJvcGVydHkoJ2RhdGUnKTtcbiAgICAgIGV4cGVjdChzYW1wbGVSZXBvcnQuX2lkKS50b0hhdmVQcm9wZXJ0eSgnY2F0ZWdvcnknKTtcbiAgICAgIGV4cGVjdChzYW1wbGVSZXBvcnQpLnRvSGF2ZVByb3BlcnR5KCd0b3RhbEFtb3VudCcpO1xuICAgICAgZXhwZWN0KHNhbXBsZVJlcG9ydCkudG9IYXZlUHJvcGVydHkoJ2NvdW50Jyk7XG4gICAgfSk7XG5cbiAgICB0ZXN0KCdzaG91bGQgY2FsY3VsYXRlIGNvcnJlY3QgbW9udGhseSBjYXRlZ29yeSB0b3RhbHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCB0ZXN0RXhwZW5zZXMgPSBnZW5lcmF0ZVRlc3RFeHBlbnNlcygxMDApO1xuICAgICAgYXdhaXQgQW5hbHl0aWNzRXZlbnQuaW5zZXJ0TWFueSh0ZXN0RXhwZW5zZXMpO1xuXG4gICAgICBjb25zdCBwaXBlbGluZSA9IFtcbiAgICAgICAge1xuICAgICAgICAgICRncm91cDoge1xuICAgICAgICAgICAgX2lkOiB7XG4gICAgICAgICAgICAgIG1vbnRoOiB7ICRtb250aDogJyR0aW1lc3RhbXAnIH0sXG4gICAgICAgICAgICAgIGNhdGVnb3J5OiAnJGNhdGVnb3J5J1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHRvdGFsQW1vdW50OiB7ICRzdW06ICckYW1vdW50JyB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICBdO1xuXG4gICAgICBjb25zdCBtb250aGx5VG90YWxzID0gYXdhaXQgQW5hbHl0aWNzRXZlbnQuYWdncmVnYXRlKHBpcGVsaW5lKTtcbiAgICAgIFxuICAgICAgLy8gVmVyaWZ5IHRvdGFsc1xuICAgICAgbW9udGhseVRvdGFscy5mb3JFYWNoKHRvdGFsID0+IHtcbiAgICAgICAgZXhwZWN0KHRvdGFsLnRvdGFsQW1vdW50KS50b0JlR3JlYXRlclRoYW4oMCk7XG4gICAgICAgIGV4cGVjdCh0b3RhbC5faWQubW9udGgpLnRvQmVMZXNzVGhhbk9yRXF1YWwoMTIpO1xuICAgICAgICBleHBlY3QodG90YWwuX2lkLm1vbnRoKS50b0JlR3JlYXRlclRoYW5PckVxdWFsKDEpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdSZXBvcnQgR2VuZXJhdGlvbiBQaXBlbGluZScsICgpID0+IHtcbiAgICB0ZXN0KCdzaG91bGQgZ2VuZXJhdGUgYW5kIHN0b3JlIHNwZW5kaW5nIHJlcG9ydHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCB0ZXN0RXhwZW5zZXMgPSBnZW5lcmF0ZVRlc3RFeHBlbnNlcygxMDApO1xuICAgICAgYXdhaXQgQW5hbHl0aWNzRXZlbnQuaW5zZXJ0TWFueSh0ZXN0RXhwZW5zZXMpO1xuXG4gICAgICAvLyBHZW5lcmF0ZSByZXBvcnRcbiAgICAgIGNvbnN0IHJlcG9ydERhdGEgPSB7XG4gICAgICAgIHVzZXJJZDogdGVzdEV4cGVuc2VzWzBdLnVzZXJJZCxcbiAgICAgICAgcGVyaW9kOiAnbW9udGhseScsXG4gICAgICAgIHN0YXJ0RGF0ZTogbmV3IERhdGUoJzIwMjQtMDEtMDEnKSxcbiAgICAgICAgZW5kRGF0ZTogbmV3IERhdGUoJzIwMjQtMDEtMzEnKSxcbiAgICAgICAgdG90YWxTcGVuZGluZzogdGVzdEV4cGVuc2VzLnJlZHVjZSgoc3VtLCBleHApID0+IHN1bSArIGV4cC5hbW91bnQsIDApLFxuICAgICAgICBjYXRlZ29yeUJyZWFrZG93bjoge30sXG4gICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKVxuICAgICAgfTtcblxuICAgICAgY29uc3QgcmVwb3J0ID0gYXdhaXQgU3BlbmRpbmdSZXBvcnQuY3JlYXRlKHJlcG9ydERhdGEpO1xuICAgICAgXG4gICAgICAvLyBWZXJpZnkgcmVwb3J0IHdhcyBzdG9yZWRcbiAgICAgIGV4cGVjdChyZXBvcnQuX2lkKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KHJlcG9ydC51c2VySWQpLnRvQmUocmVwb3J0RGF0YS51c2VySWQpO1xuICAgICAgZXhwZWN0KHJlcG9ydC50b3RhbFNwZW5kaW5nKS50b0JlKHJlcG9ydERhdGEudG90YWxTcGVuZGluZyk7XG4gICAgfSk7XG5cbiAgICB0ZXN0KCdzaG91bGQgdXBkYXRlIGV4aXN0aW5nIHJlcG9ydHMgd2l0aCBuZXcgZGF0YScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHRlc3RFeHBlbnNlcyA9IGdlbmVyYXRlVGVzdEV4cGVuc2VzKDUwKTtcbiAgICAgIGF3YWl0IEFuYWx5dGljc0V2ZW50Lmluc2VydE1hbnkodGVzdEV4cGVuc2VzKTtcblxuICAgICAgLy8gQ3JlYXRlIGluaXRpYWwgcmVwb3J0XG4gICAgICBjb25zdCBpbml0aWFsUmVwb3J0ID0gYXdhaXQgU3BlbmRpbmdSZXBvcnQuY3JlYXRlKHtcbiAgICAgICAgdXNlcklkOiB0ZXN0RXhwZW5zZXNbMF0udXNlcklkLFxuICAgICAgICBwZXJpb2Q6ICdtb250aGx5JyxcbiAgICAgICAgc3RhcnREYXRlOiBuZXcgRGF0ZSgnMjAyNC0wMS0wMScpLFxuICAgICAgICBlbmREYXRlOiBuZXcgRGF0ZSgnMjAyNC0wMS0zMScpLFxuICAgICAgICB0b3RhbFNwZW5kaW5nOiAxMDAwLFxuICAgICAgICBjYXRlZ29yeUJyZWFrZG93bjoge30sXG4gICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKVxuICAgICAgfSk7XG5cbiAgICAgIC8vIFVwZGF0ZSByZXBvcnRcbiAgICAgIGNvbnN0IHVwZGF0ZWRUb3RhbCA9IDE1MDA7XG4gICAgICBhd2FpdCBTcGVuZGluZ1JlcG9ydC5maW5kQnlJZEFuZFVwZGF0ZShcbiAgICAgICAgaW5pdGlhbFJlcG9ydC5faWQsXG4gICAgICAgIHsgdG90YWxTcGVuZGluZzogdXBkYXRlZFRvdGFsIH0sXG4gICAgICAgIHsgbmV3OiB0cnVlIH1cbiAgICAgICk7XG5cbiAgICAgIC8vIFZlcmlmeSB1cGRhdGVcbiAgICAgIGNvbnN0IHJlcG9ydCA9IGF3YWl0IFNwZW5kaW5nUmVwb3J0LmZpbmRCeUlkKGluaXRpYWxSZXBvcnQuX2lkKTtcbiAgICAgIGV4cGVjdChyZXBvcnQudG90YWxTcGVuZGluZykudG9CZSh1cGRhdGVkVG90YWwpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnRXJyb3IgSGFuZGxpbmcnLCAoKSA9PiB7XG4gICAgdGVzdCgnc2hvdWxkIGhhbmRsZSBpbnZhbGlkIGRhdGEgZ3JhY2VmdWxseScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGludmFsaWRFeHBlbnNlID0ge1xuICAgICAgICB1c2VySWQ6ICd0ZXN0LXVzZXInLFxuICAgICAgICBhbW91bnQ6ICdpbnZhbGlkLWFtb3VudCcsIC8vIFNob3VsZCBiZSBhIG51bWJlclxuICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCksXG4gICAgICAgIGNhdGVnb3J5OiAnZm9vZCdcbiAgICAgIH07XG5cbiAgICAgIGF3YWl0IGV4cGVjdChBbmFseXRpY3NFdmVudC5jcmVhdGUoaW52YWxpZEV4cGVuc2UpKS5yZWplY3RzLnRvVGhyb3coKTtcbiAgICB9KTtcblxuICAgIHRlc3QoJ3Nob3VsZCBoYW5kbGUgbWlzc2luZyByZXF1aXJlZCBmaWVsZHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBpbmNvbXBsZXRlRXhwZW5zZSA9IHtcbiAgICAgICAgdXNlcklkOiAndGVzdC11c2VyJyxcbiAgICAgICAgLy8gTWlzc2luZyBhbW91bnQgYW5kIGNhdGVnb3J5XG4gICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKVxuICAgICAgfTtcblxuICAgICAgYXdhaXQgZXhwZWN0KEFuYWx5dGljc0V2ZW50LmNyZWF0ZShpbmNvbXBsZXRlRXhwZW5zZSkpLnJlamVjdHMudG9UaHJvdygpO1xuICAgIH0pO1xuICB9KTtcbn0pOyAiXSwibWFwcGluZ3MiOiI4WkFBQSxJQUFBQSxTQUFBLEdBQUFDLHNCQUFBLENBQUFDLE9BQUE7QUFDQSxJQUFBQyxNQUFBLEdBQUFELE9BQUE7QUFDQSxJQUFBRSxlQUFBLEdBQUFILHNCQUFBLENBQUFDLE9BQUE7QUFDQSxJQUFBRyxlQUFBLEdBQUFKLHNCQUFBLENBQUFDLE9BQUE7O0FBRUFJLFFBQVEsQ0FBQyw0Q0FBNEMsRUFBRSxNQUFNO0VBQzNEQyxTQUFTLENBQUMsWUFBWTtJQUNwQixNQUFNLElBQUFDLGtCQUFXLEVBQUMsQ0FBQztFQUNyQixDQUFDLENBQUM7O0VBRUZDLFFBQVEsQ0FBQyxZQUFZO0lBQ25CLE1BQU0sSUFBQUMscUJBQWMsRUFBQyxDQUFDO0VBQ3hCLENBQUMsQ0FBQzs7RUFFRkMsVUFBVSxDQUFDLFlBQVk7SUFDckIsTUFBTUMsdUJBQWMsQ0FBQ0MsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ25DLE1BQU1DLHVCQUFjLENBQUNELFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztFQUNyQyxDQUFDLENBQUM7O0VBRUZQLFFBQVEsQ0FBQyx5QkFBeUIsRUFBRSxNQUFNO0lBQ3hDUyxJQUFJLENBQUMsMkRBQTJELEVBQUUsWUFBWTtNQUM1RSxNQUFNQyxZQUFZLEdBQUcsSUFBQUMsMkJBQW9CLEVBQUMsR0FBRyxDQUFDOztNQUU5QztNQUNBLE1BQU1MLHVCQUFjLENBQUNNLFVBQVUsQ0FBQ0YsWUFBWSxDQUFD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